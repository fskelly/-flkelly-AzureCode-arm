on: [push]

name: AzureCLISampleForFile

jobs:

  AZCli-CheckRGExists:
    runs-on: ubuntu-latest
    steps:
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Checkout
      uses: actions/checkout@v1

    - name: Azure CLI script file
      uses: azure/CLI@v1
      with:
        azcliversion: 2.0.72
        inlineScript: |
          RESOURCEGROUPNAME="arm-actions"
          LOCATION="westeurope"
          if [ $(az group exists --name $RESOURCEGROUPNAME) = false ]; then     az group create --name $RESOURCEGROUPNAME --location $LOCATION; fi
          
  build-and-deploy:
    needs: AZCli-CheckRGExists
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Master 
      uses: actions/checkout@master
    - name: ARM Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: arm Deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.SUB_ID }}
        resourceGroupName: github-action-arm-rg
        template: ./virtualMachine/arm/SimpleVM1/deploy.json
        parameters: ./virtualMachine/arm/SimpleVM1/parameters1.json